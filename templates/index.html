{% extends "base.html" %} {% block title %}Dashboard - Hotel Performance{%
endblock %} {% block extra_head %}
<!-- Chart.js CDN - CRITICAL: Load this first -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
{% endblock %} {% block extra_css %}
<style>
  .metric-card {
    transition: transform 0.2s ease-in-out;
    border-left: 4px solid transparent;
  }
  .metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  .metric-card.positive {
    border-left-color: #28a745;
  }
  .metric-card.negative {
    border-left-color: #dc3545;
  }
  .metric-card.neutral {
    border-left-color: #6c757d;
  }
  .quick-actions {
    position: sticky;
    top: 80px;
    z-index: 100;
  }
  .chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
  }
  .data-entry-form {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .table-responsive {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .progress-thin {
    height: 4px;
  }

  /* NEW: Styles for duplicate handling */
  .duplicate-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    padding: 12px;
    margin-top: 10px;
  }

  .update-mode .modal-header {
    background-color: #e3f2fd;
  }

  .submission-disabled {
    opacity: 0.6;
    pointer-events: none;
  }

  /* Chart loading states */
  .chart-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 300px;
    flex-direction: column;
    color: #6c757d;
  }

  .chart-error {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 300px;
    flex-direction: column;
    color: #6c757d;
  }

  /* NEW: Comments field styling */
  .comments-section {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    border-left: 4px solid #17a2b8;
  }

  /* Enhanced AI insights styling */
  .ai-insights-fresh {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    border-left: 4px solid #2196f3;
  }

  /* NEW: Edit functionality styles */
  .edit-mode .modal-header {
    background-color: #fff3cd;
    border-bottom: 1px solid #ffeaa7;
  }

  .edit-mode .modal-title {
    color: #856404;
  }

  .btn-edit {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 0.2rem;
  }

  .data-row:hover {
    background-color: #f8f9fa;
  }

  .data-row:hover .btn-edit {
    opacity: 1;
  }

  .btn-edit {
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  .recent-data-actions {
    min-width: 80px;
  }

  /* Delete button styling */
  .btn-delete-confirm {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
  }

  .btn-delete-confirm:hover {
    background-color: #c82333;
    border-color: #bd2130;
  }

  /* Modal mode indicators */
  .modal-mode-indicator {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    margin-left: 0.5rem;
  }

  .mode-add {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .mode-edit {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid py-4">
  <!-- Welcome Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1">
            <i class="fas fa-tachometer-alt text-primary me-2"></i>
            Welcome back, {{ user_name }}!
          </h1>
          <p class="text-muted mb-0">Here's your hotel performance overview</p>
        </div>
        <div class="quick-actions">
          <button
            class="btn btn-primary me-2"
            data-bs-toggle="modal"
            data-bs-target="#dataEntryModal"
            id="addDataBtn"
            onclick="setModalMode('add')"
          >
            <i class="fas fa-plus me-1"></i>Add Today's Data
          </button>
          <a href="{{ url_for('reports') }}" class="btn btn-outline-primary">
            <i class="fas fa-chart-line me-1"></i>View Reports
          </a>
          <!-- TEMPORARY DEBUG BUTTON -->
          <button
            class="btn btn-outline-info btn-sm ms-2"
            onclick="debugChart()"
          >
            <i class="fas fa-bug me-1"></i>Debug
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Key Metrics Row -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
      <div
        class="card metric-card h-100 {% if stats.get('avg_room_rate_variance', 0) >= 0 %}positive{% else %}negative{% endif %}"
      >
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="card-subtitle mb-2 text-muted">
                Avg Room Rate Variance
              </h6>
              <h4 class="card-title mb-1">
                ${{ "%.2f"|format(stats.get('avg_room_rate_variance', 0)) }}
              </h4>
              <small class="text-muted">
                {{ "%.1f"|format(stats.get('avg_room_rate_variance_pct', 0)) }}%
              </small>
            </div>
            <div
              class="text-{% if stats.get('avg_room_rate_variance', 0) >= 0 %}success{% else %}danger{% endif %}"
            >
              <i class="fas fa-bed fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
      <div
        class="card metric-card h-100 {% if stats.get('avg_revenue_variance', 0) >= 0 %}positive{% else %}negative{% endif %}"
      >
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="card-subtitle mb-2 text-muted">
                Avg Revenue Variance
              </h6>
              <h4 class="card-title mb-1">
                ${{ "{:,.2f}".format(stats.get('avg_revenue_variance', 0)) }}
              </h4>
              <small class="text-muted">
                {{ "%.1f"|format(stats.get('avg_revenue_variance_pct', 0)) }}%
              </small>
            </div>
            <div
              class="text-{% if stats.get('avg_revenue_variance', 0) >= 0 %}success{% else %}danger{% endif %}"
            >
              <i class="fas fa-dollar-sign fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card metric-card h-100 neutral">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="card-subtitle mb-2 text-muted">Total Data Points</h6>
              <h4 class="card-title mb-1">
                {{ stats.get('total_records', 0) }}
              </h4>
              <small class="text-muted">Days tracked</small>
            </div>
            <div class="text-info">
              <i class="fas fa-database fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card metric-card h-100 neutral">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="card-subtitle mb-2 text-muted">Performance Score</h6>
              <h4 class="card-title mb-1">
                {{ stats.get('performance_score', 85) }}%
              </h4>
              <small class="text-muted">Overall rating</small>
            </div>
            <div class="text-warning">
              <i class="fas fa-star fa-2x"></i>
            </div>
          </div>
          <div class="progress progress-thin mt-2">
            <div
              class="progress-bar bg-warning"
              role="progressbar"
              style="width: {{ stats.get('performance_score', 85) }}%"
              aria-valuenow="{{ stats.get('performance_score', 85) }}"
              aria-valuemin="0"
              aria-valuemax="100"
            ></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Row -->
  <div class="row">
    <!-- Left Column - Charts and Analysis -->
    <div class="col-lg-8">
      <!-- Performance Chart -->
      <div class="card mb-4">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="card-title mb-0">
            <i class="fas fa-chart-line me-2"></i>Recent Performance Trend
          </h5>
          <div class="btn-group btn-group-sm" role="group">
            <input
              type="radio"
              class="btn-check"
              name="chartPeriod"
              id="period7"
              value="7"
              checked
            />
            <label class="btn btn-outline-primary" for="period7">7D</label>

            <input
              type="radio"
              class="btn-check"
              name="chartPeriod"
              id="period30"
              value="30"
            />
            <label class="btn btn-outline-primary" for="period30">30D</label>
          </div>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="performanceChart"></canvas>
          </div>
        </div>
      </div>

      <!-- AI Insights & Forecast -->
      <div class="row">
        <div class="col-md-6">
          <div class="card mb-4">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h6 class="card-title mb-0">
                <i class="fas fa-brain me-2"></i>AI Insights
              </h6>
              <button
                class="btn btn-sm btn-outline-primary"
                id="generateInsightsBtn"
              >
                <i class="fas fa-sync-alt me-1"></i>Refresh
              </button>
            </div>
            <div class="card-body">
              <div id="aiInsights" class="text-muted">
                <div class="text-center py-3">
                  <i class="fas fa-lightbulb fa-2x mb-2"></i>
                  <p>
                    AI insights will appear here after you add performance data
                  </p>
                  <small class="text-muted"
                    >Insights are generated automatically when you submit new
                    data</small
                  >
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card mb-4">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h6 class="card-title mb-0">
                <i class="fas fa-crystal-ball me-2"></i>7-Day Forecast
              </h6>
              <div class="dropdown">
                <button
                  class="btn btn-sm btn-outline-primary dropdown-toggle"
                  type="button"
                  data-bs-toggle="dropdown"
                >
                  Revenue
                </button>
                <ul class="dropdown-menu">
                  <li>
                    <a
                      class="dropdown-item forecast-metric"
                      href="#"
                      data-metric="revenue"
                      >Revenue</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item forecast-metric"
                      href="#"
                      data-metric="room_rate"
                      >Room Rate</a
                    >
                  </li>
                </ul>
              </div>
            </div>
            <div class="card-body">
              <div id="forecastData" class="text-muted">
                <div class="text-center py-3">
                  <i class="fas fa-chart-area fa-2x mb-2"></i>
                  <p>Select metric to view forecast</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Recent Data with Edit Functionality -->
    <div class="col-lg-4">
      <!-- Recent Performance Data with Edit Buttons -->
      <div class="card">
        <div class="card-header">
          <h6 class="card-title mb-0">
            <i class="fas fa-history me-2"></i>Recent Performance (Last 7 Days)
          </h6>
        </div>
        <div class="card-body p-0">
          {% if recent_data %}
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Rate Var.</th>
                  <th>Rev. Var.</th>
                  <th class="recent-data-actions">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for data in recent_data %}
                <tr class="data-row">
                  <td>
                    <small
                      >{{ data.date.strftime('%m/%d') if data.date else 'N/A'
                      }}</small
                    >
                  </td>
                  <td>
                    <span
                      class="badge bg-{% if data.room_rate_variance >= 0 %}success{% else %}danger{% endif %}"
                    >
                      ${{ "%.0f"|format(data.room_rate_variance or 0) }}
                    </span>
                  </td>
                  <td>
                    <span
                      class="badge bg-{% if data.revenue_variance >= 0 %}success{% else %}danger{% endif %}"
                    >
                      ${{ "{:,.0f}".format(data.revenue_variance or 0) }}
                    </span>
                  </td>
                  <td class="recent-data-actions">
                    <button
                      class="btn btn-outline-primary btn-edit"
                      onclick="editDataEntry('{{ data.date.strftime('%Y-%m-%d') if data.date else '' }}', 
                               {{ data.target_room_rate or 0 }}, 
                               {{ data.actual_room_rate or 0 }}, 
                               {{ data.target_revenue or 0 }}, 
                               {{ data.actual_revenue or 0 }},
                               '{{ data.notes or '' }}')"
                      title="Edit this entry"
                      data-bs-toggle="modal"
                      data-bs-target="#dataEntryModal"
                    >
                      <i class="fas fa-edit"></i>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-4 text-muted">
            <i class="fas fa-inbox fa-2x mb-2"></i>
            <p class="mb-0">No recent data available</p>
            <small>Add your first performance entry</small>
          </div>
          {% endif %}
        </div>
        <div class="card-footer text-center">
          <a href="{{ url_for('reports') }}" class="btn btn-sm btn-primary">
            View All Data <i class="fas fa-arrow-right ms-1"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Data Entry Modal with Edit Support -->
<div
  class="modal fade"
  id="dataEntryModal"
  tabindex="-1"
  aria-labelledby="dataEntryModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="modalContent">
      <!-- Enhanced Modal Header with Mode Indication -->
      <div class="modal-header" id="modalHeader">
        <h5 class="modal-title" id="dataEntryModalLabel">
          <i class="fas fa-plus-circle me-2" id="modalIcon"></i>
          <span id="modalTitleText">Add Performance Data</span>
          <span class="modal-mode-indicator mode-add" id="modeIndicator"
            >New Entry</span
          >
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
          onclick="resetModalState()"
        ></button>
      </div>
      <form id="dataEntryForm">
        <div class="modal-body">
          <!-- Alert container for messages -->
          <div id="alertContainer"></div>

          <!-- Hidden field to track edit mode -->
          <input type="hidden" id="editMode" name="edit_mode" value="false" />
          <input
            type="hidden"
            id="originalDate"
            name="original_date"
            value=""
          />

          <div class="data-entry-form">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="entryDate" class="form-label">Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="entryDate"
                  name="date"
                  required
                />
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  <span id="modalInstructions"
                    >Enter today's performance data</span
                  >
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="targetRoomRate" class="form-label"
                  >Target Room Rate ($)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="targetRoomRate"
                  name="target_room_rate"
                  step="0.01"
                  min="0"
                  required
                />
              </div>
              <div class="col-md-6 mb-3">
                <label for="actualRoomRate" class="form-label"
                  >Actual Room Rate ($)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="actualRoomRate"
                  name="actual_room_rate"
                  step="0.01"
                  min="0"
                  required
                />
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="targetRevenue" class="form-label"
                  >Target Revenue ($)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="targetRevenue"
                  name="target_revenue"
                  step="0.01"
                  min="0"
                  required
                />
              </div>
              <div class="col-md-6 mb-3">
                <label for="actualRevenue" class="form-label"
                  >Actual Revenue ($)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="actualRevenue"
                  name="actual_revenue"
                  step="0.01"
                  min="0"
                  required
                />
              </div>
            </div>

            <!-- Comments Section -->
            <div class="comments-section">
              <div class="row">
                <div class="col-12 mb-3">
                  <label for="performanceNotes" class="form-label">
                    <i class="fas fa-comment-alt me-1"></i>Performance Notes &
                    Comments
                  </label>
                  <textarea
                    class="form-control"
                    id="performanceNotes"
                    name="notes"
                    rows="3"
                    placeholder="Add any notes about today's performance, market conditions, special events, or operational insights..."
                  ></textarea>
                  <div class="form-text">
                    <small
                      ><i class="fas fa-lightbulb text-info me-1"></i>These
                      notes will help with AI analysis and your own performance
                      tracking.</small
                    >
                  </div>
                </div>
              </div>
            </div>

            <!-- Live Variance Display -->
            <div class="row" id="variancePreview" style="display: none">
              <div class="col-12">
                <div class="alert alert-info">
                  <h6>Calculated Variances:</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <strong>Room Rate:</strong>
                      <span id="roomRateVariance">$0.00</span>
                      (<span id="roomRateVariancePct">0.0%</span>)
                    </div>
                    <div class="col-md-6">
                      <strong>Revenue:</strong>
                      <span id="revenueVariance">$0.00</span>
                      (<span id="revenueVariancePct">0.0%</span>)
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Enhanced Modal Footer with Delete Option -->
        <div class="modal-footer" id="modalFooter">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
            onclick="resetModalState()"
          >
            Cancel
          </button>
          <!-- Delete button (only visible in edit mode) -->
          <button
            type="button"
            class="btn btn-danger"
            id="deleteDataBtn"
            style="display: none"
            onclick="deleteDataEntry()"
          >
            <i class="fas fa-trash me-1"></i>Delete
          </button>
          <button type="submit" class="btn btn-primary" id="submitDataBtn">
            <i class="fas fa-save me-1"></i
            ><span id="submitBtnText">Save Data</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}

<script>
  // ===============================================
  // ENHANCED FORM WITH EDIT FUNCTIONALITY
  // ===============================================

  console.log('=== STARTING ENHANCED FORM WITH EDIT SUPPORT ===');

  // Get data from Flask
  let performanceData = {{ recent_data | tojson if recent_data else '[]' }};
  let summaryStats = {{ stats | tojson if stats else '{}' }};

  console.log('Flask data received:');
  console.log('- Performance data:', performanceData);
  console.log('- Summary stats:', summaryStats);

  // ENHANCED: State management with edit support
  let formState = {
      isSubmitting: false,
      isInitialized: false,
      submitAttempts: 0,
      lastSubmissionTime: 0,
      currentMode: 'add', // 'add' or 'edit'
      editingDate: null
  };

  // Simple initialization
  document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up...');

      // Set today's date for new entries
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('entryDate').value = today;

      // Setup form validation - ONLY ONCE
      if (!formState.isInitialized) {
          setupFormValidation();
          formState.isInitialized = true;
      }

      // Wait for Chart.js and create chart
      waitForChartJS();
  });

  // ===============================================
  // EDIT FUNCTIONALITY
  // ===============================================

  function setModalMode(mode, data = null) {
      console.log('Setting modal mode:', mode, data);

      formState.currentMode = mode;

      const modalHeader = document.getElementById('modalHeader');
      const modalIcon = document.getElementById('modalIcon');
      const modalTitleText = document.getElementById('modalTitleText');
      const modeIndicator = document.getElementById('modeIndicator');
      const modalInstructions = document.getElementById('modalInstructions');
      const deleteBtn = document.getElementById('deleteDataBtn');
      const submitBtnText = document.getElementById('submitBtnText');
      const editModeInput = document.getElementById('editMode');
      const originalDateInput = document.getElementById('originalDate');

      if (mode === 'edit') {
          // Edit mode styling and content
          modalHeader.className = 'modal-header edit-mode';
          modalIcon.className = 'fas fa-edit me-2';
          modalTitleText.textContent = 'Edit Performance Data';
          modeIndicator.className = 'modal-mode-indicator mode-edit';
          modeIndicator.textContent = 'Editing Entry';
          modalInstructions.textContent = 'Modify the performance data for this date';
          deleteBtn.style.display = 'inline-block';
          submitBtnText.textContent = 'Update Data';
          editModeInput.value = 'true';
          originalDateInput.value = data ? data.date : '';

          // Populate form with existing data
          if (data) {
              populateForm(data);
              formState.editingDate = data.date;
          }
      } else {
          // Add mode styling and content
          modalHeader.className = 'modal-header';
          modalIcon.className = 'fas fa-plus-circle me-2';
          modalTitleText.textContent = 'Add Performance Data';
          modeIndicator.className = 'modal-mode-indicator mode-add';
          modeIndicator.textContent = 'New Entry';
          modalInstructions.textContent = 'Enter today\'s performance data';
          deleteBtn.style.display = 'none';
          submitBtnText.textContent = 'Save Data';
          editModeInput.value = 'false';
          originalDateInput.value = '';

          // Reset form for new entry
          resetFormForNewEntry();
          formState.editingDate = null;
      }
  }

  function editDataEntry(date, targetRoom, actualRoom, targetRev, actualRev, notes) {
      console.log('Edit data entry called:', { date, targetRoom, actualRoom, targetRev, actualRev, notes });

      const data = {
          date: date,
          target_room_rate: targetRoom,
          actual_room_rate: actualRoom,
          target_revenue: targetRev,
          actual_revenue: actualRev,
          notes: notes || ''
      };

      setModalMode('edit', data);
  }

  function populateForm(data) {
      console.log('Populating form with data:', data);

      // Set form values
      document.getElementById('entryDate').value = data.date;
      document.getElementById('targetRoomRate').value = data.target_room_rate;
      document.getElementById('actualRoomRate').value = data.actual_room_rate;
      document.getElementById('targetRevenue').value = data.target_revenue;
      document.getElementById('actualRevenue').value = data.actual_revenue;
      document.getElementById('performanceNotes').value = data.notes || '';

      // Disable date field in edit mode to prevent confusion
      document.getElementById('entryDate').disabled = true;

      // Calculate and show variances
      calculateVariances();
  }

  function resetFormForNewEntry() {
      console.log('Resetting form for new entry');

      // Reset form
      const form = document.getElementById('dataEntryForm');
      form.reset();

      // Set today's date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('entryDate').value = today;

      // Re-enable date field
      document.getElementById('entryDate').disabled = false;

      // Hide variance preview
      document.getElementById('variancePreview').style.display = 'none';

      // Clear validation states
      const invalidFields = form.querySelectorAll('.is-invalid');
      invalidFields.forEach(field => field.classList.remove('is-invalid'));
  }

  function resetModalState() {
      console.log('Resetting modal state');

      // Reset to add mode
      setModalMode('add');

      // Reset form state
      formState.isSubmitting = false;
      formState.editingDate = null;
  }

  function deleteDataEntry() {
      const dateToDelete = formState.editingDate || document.getElementById('entryDate').value;

      if (!dateToDelete) {
          showNotification('No date specified for deletion', 'error');
          return;
      }

      // Confirm deletion
      if (!confirm(`Are you sure you want to delete the performance data for ${dateToDelete}? This action cannot be undone.`)) {
          return;
      }

      console.log('Deleting data for date:', dateToDelete);

      const deleteBtn = document.getElementById('deleteDataBtn');
      const originalText = deleteBtn.innerHTML;

      deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
      deleteBtn.disabled = true;

      fetch('/delete-data', {
          method: 'DELETE',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({ date: dateToDelete })
      })
      .then(response => response.json())
      .then(result => {
          if (result.success) {
              showNotification('Performance data deleted successfully', 'success');

              // Close modal and refresh page
              const modal = bootstrap.Modal.getInstance(document.getElementById('dataEntryModal'));
              if (modal) modal.hide();

              setTimeout(() => {
                  location.reload();
              }, 1500);
          } else {
              showNotification('Error: ' + (result.error || 'Failed to delete data'), 'error');
          }
      })
      .catch(error => {
          console.error('Error deleting data:', error);
          showNotification('Network error. Please try again.', 'error');
      })
      .finally(() => {
          deleteBtn.innerHTML = originalText;
          deleteBtn.disabled = false;
      });
  }

  // ===============================================
  // CHART FUNCTIONALITY (UNCHANGED)
  // ===============================================

  function waitForChartJS() {
      console.log('Waiting for Chart.js...');

      let attempts = 0;
      const maxAttempts = 50;

      const checkInterval = setInterval(() => {
          attempts++;
          console.log(`Attempt ${attempts}: Chart.js available?`, typeof Chart !== 'undefined');

          if (typeof Chart !== 'undefined') {
              console.log('✅ Chart.js found! Creating chart...');
              clearInterval(checkInterval);
              createSimpleChart();
          } else if (attempts >= maxAttempts) {
              console.error('❌ Chart.js failed to load');
              clearInterval(checkInterval);
              showError('Chart.js failed to load');
          }
      }, 200);
  }

  function createSimpleChart() {
      console.log('=== CREATING SIMPLE CHART ===');

      const canvas = document.getElementById('performanceChart');
      if (!canvas) {
          console.error('Canvas not found');
          showError('Chart canvas not found');
          return;
      }

      const ctx = canvas.getContext('2d');
      console.log('Canvas context:', ctx);

      // Check data
      if (!performanceData || performanceData.length === 0) {
          console.log('No data available, showing message');
          showNoData();
          return;
      }

      console.log('Processing', performanceData.length, 'data points');

      try {
          // Simple data processing
          const labels = [];
          const revenueData = [];

          for (let i = 0; i < performanceData.length; i++) {
              const item = performanceData[i];
              console.log(`Processing item ${i}:`, item);

              // Simple date handling
              let dateStr = 'Day ' + (i + 1);
              if (item.date) {
                  try {
                      const date = new Date(item.date);
                      dateStr = (date.getMonth() + 1) + '/' + date.getDate();
                  } catch (e) {
                      console.warn('Date parsing failed:', item.date);
                  }
              }

              labels.push(dateStr);
              revenueData.push(parseFloat(item.actual_revenue || 0));
          }

          console.log('Chart data prepared:');
          console.log('- Labels:', labels);
          console.log('- Revenue data:', revenueData);

          // Create super simple chart
          const chart = new Chart(ctx, {
              type: 'line',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Revenue ($)',
                      data: revenueData,
                      borderColor: '#007bff',
                      backgroundColor: 'rgba(0, 123, 255, 0.1)',
                      tension: 0.4,
                      fill: true
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      title: {
                          display: true,
                          text: 'Performance Overview'
                      }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: {
                              callback: function(value) {
                                  return '$' + value.toLocaleString();
                              }
                          }
                      }
                  }
              }
          });

          console.log('✅ Chart created successfully!', chart);

      } catch (error) {
          console.error('❌ Chart creation failed:', error);
          showError('Chart creation failed: ' + error.message);
      }
  }

  function showError(message) {
      const container = document.querySelector('.chart-container');
      if (container) {
          container.innerHTML = `
              <div class="chart-error">
                  <i class="fas fa-exclamation-triangle fa-2x mb-2 text-danger"></i>
                  <h6>Chart Error</h6>
                  <p>${message}</p>
                  <button class="btn btn-sm btn-primary" onclick="createSimpleChart()">
                      <i class="fas fa-redo me-1"></i>Retry
                  </button>
              </div>
          `;
      }
  }

  function showNoData() {
      const container = document.querySelector('.chart-container');
      if (container) {
          container.innerHTML = `
              <div class="chart-error">
                  <i class="fas fa-chart-line fa-2x mb-2 text-muted"></i>
                  <h6>No Data Available</h6>
                  <p>Add some performance data to see your chart!</p>
                  <button class="btn btn-sm btn-primary" onclick="document.querySelector('[data-bs-target=\\\"#dataEntryModal\\\"]').click()">
                      <i class="fas fa-plus me-1"></i>Add Data
                  </button>
              </div>
          `;
      }
  }

  // Debug function
  function debugChart() {
      console.log('=== DEBUG INFORMATION ===');
      console.log('Chart.js available:', typeof Chart !== 'undefined');
      console.log('Performance data:', performanceData);
      console.log('Canvas element:', document.getElementById('performanceChart'));

      if (typeof Chart !== 'undefined') {
          console.log('Chart.js version:', Chart.version);
          console.log('Trying to create chart...');
          createSimpleChart();
      } else {
          console.log('Chart.js not available, checking scripts...');
          const scripts = Array.from(document.scripts).map(s => s.src).filter(s => s.includes('chart'));
          console.log('Chart scripts found:', scripts);

          alert('Chart.js not loaded. Check console for details.');
      }
  }

  // ===============================================
  // ENHANCED FORM FUNCTIONALITY WITH EDIT SUPPORT
  // ===============================================

  function setupFormValidation() {
      console.log('Setting up form validation...');

      const form = document.getElementById('dataEntryForm');
      if (!form) {
          console.error('Form not found');
          return;
      }

      // ENHANCED: Remove any existing event listeners first
      const newForm = form.cloneNode(true);
      form.parentNode.replaceChild(newForm, form);

      // Add single event listener to the fresh form
      newForm.addEventListener('submit', function(e) {
          e.preventDefault();
          e.stopPropagation();

          console.log('Form submit triggered, current state:', formState);

          // ENHANCED: Multiple levels of duplicate prevention
          if (formState.isSubmitting) {
              console.log('Already submitting, ignoring...');
              return false;
          }

          // ENHANCED: Prevent rapid-fire submissions
          const now = Date.now();
          if (now - formState.lastSubmissionTime < 2000) { // 2 second cooldown
              console.log('Too soon since last submission, ignoring...');
              showNotification('Please wait a moment before submitting again.', 'warning');
              return false;
          }

          // Route to appropriate submission handler
          if (formState.currentMode === 'edit') {
              updatePerformanceData();
          } else {
              submitPerformanceData();
          }
          return false;
      });

      // ENHANCED: Prevent multiple button clicks
      const submitBtn = document.getElementById('submitDataBtn');
      if (submitBtn) {
          submitBtn.addEventListener('click', function(e) {
              if (formState.isSubmitting) {
                  e.preventDefault();
                  e.stopPropagation();
                  return false;
              }
          });
      }

      // Form input listeners for live variance calculation
      const inputs = ['targetRoomRate', 'actualRoomRate', 'targetRevenue', 'actualRevenue'];
      inputs.forEach(inputId => {
          const input = document.getElementById(inputId);
          if (input) {
              input.addEventListener('input', calculateVariances);
          }
      });

      console.log('Form validation setup complete');
  }

  function calculateVariances() {
      const targetRoom = parseFloat(document.getElementById('targetRoomRate').value) || 0;
      const actualRoom = parseFloat(document.getElementById('actualRoomRate').value) || 0;
      const targetRev = parseFloat(document.getElementById('targetRevenue').value) || 0;
      const actualRev = parseFloat(document.getElementById('actualRevenue').value) || 0;

      if (targetRoom > 0 && actualRoom > 0 && targetRev > 0 && actualRev > 0) {
          const roomVariance = actualRoom - targetRoom;
          const roomVariancePct = (roomVariance / targetRoom) * 100;
          const revVariance = actualRev - targetRev;
          const revVariancePct = (revVariance / targetRev) * 100;

          document.getElementById('roomRateVariance').textContent = `$${roomVariance.toFixed(2)}`;
          document.getElementById('roomRateVariancePct').textContent = `${roomVariancePct.toFixed(1)}%`;
          document.getElementById('revenueVariance').textContent = `$${revVariance.toFixed(2)}`;
          document.getElementById('revenueVariancePct').textContent = `${revVariancePct.toFixed(1)}%`;

          document.getElementById('variancePreview').style.display = 'block';
      }
  }

  function submitPerformanceData() {
      console.log('=== STARTING NEW DATA SUBMISSION ===');

      const form = document.getElementById('dataEntryForm');
      const submitBtn = document.getElementById('submitDataBtn');

      if (!form || !submitBtn) {
          console.error('Form or submit button not found');
          return;
      }

      // ENHANCED: Validate form data before submission
      if (!validateFormData(form)) {
          return;
      }

      // ENHANCED: Set submission state immediately
      formState.isSubmitting = true;
      formState.submitAttempts++;
      formState.lastSubmissionTime = Date.now();

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      // ENHANCED: Add submission tracking
      data._submission_id = Date.now() + '_' + Math.random().toString(36).substr(2, 9);

      console.log('Submitting new data:', data);

      const originalButtonText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
      submitBtn.disabled = true;

      // ENHANCED: Disable entire form during submission
      disableForm(form, true);

      fetch('/submit', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
      })
      .then(response => {
          console.log('Response received:', response.status);
          return response.json();
      })
      .then(result => {
          console.log('Result received:', result);

          if (result.success) {
              showNotification('Success! Performance data saved successfully.', 'success');
              resetForm(form);

              // NEW: Auto-generate AI insights after successful submission
              setTimeout(() => {
                  generateAIInsightsForNewEntry(data);
              }, 1000);

              setTimeout(() => {
                  const modal = bootstrap.Modal.getInstance(document.getElementById('dataEntryModal'));
                  if (modal) modal.hide();
                  setTimeout(() => location.reload(), 2000); // Slightly longer to allow AI insights
              }, 1500);
          } else {
              // ENHANCED: Better error handling for duplicates
              if (result.error && result.error.includes('already exists')) {
                  showNotification(`Duplicate Entry: ${result.error}`, 'warning');
                  if (result.suggestion) {
                      showNotification(result.suggestion, 'info');
                  }
              } else {
                  showNotification('Error: ' + (result.error || 'Failed to save data'), 'error');
              }
          }
      })
      .catch(error => {
          console.error('Error submitting data:', error);
          showNotification('Network error. Please check your connection and try again.', 'error');
      })
      .finally(() => {
          console.log('Submission complete, resetting state...');

          // ENHANCED: Reset state properly
          formState.isSubmitting = false;

          submitBtn.innerHTML = originalButtonText;
          submitBtn.disabled = false;

          disableForm(form, false);

          console.log('State reset complete');
      });
  }

  function updatePerformanceData() {
      console.log('=== STARTING DATA UPDATE ===');

      const form = document.getElementById('dataEntryForm');
      const submitBtn = document.getElementById('submitDataBtn');

      if (!form || !submitBtn) {
          console.error('Form or submit button not found');
          return;
      }

      // ENHANCED: Validate form data before submission
      if (!validateFormData(form)) {
          return;
      }

      // ENHANCED: Set submission state immediately
      formState.isSubmitting = true;
      formState.submitAttempts++;
      formState.lastSubmissionTime = Date.now();

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      console.log('Updating data:', data);

      const originalButtonText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
      submitBtn.disabled = true;

      // ENHANCED: Disable entire form during submission
      disableForm(form, true);

      fetch('/update', {
          method: 'PUT',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
      })
      .then(response => {
          console.log('Update response received:', response.status);
          return response.json();
      })
      .then(result => {
          console.log('Update result received:', result);

          if (result.success) {
              showNotification('Success! Performance data updated successfully.', 'success');

              setTimeout(() => {
                  const modal = bootstrap.Modal.getInstance(document.getElementById('dataEntryModal'));
                  if (modal) modal.hide();
                  setTimeout(() => location.reload(), 1500);
              }, 1500);
          } else {
              showNotification('Error: ' + (result.error || 'Failed to update data'), 'error');
          }
      })
      .catch(error => {
          console.error('Error updating data:', error);
          showNotification('Network error. Please check your connection and try again.', 'error');
      })
      .finally(() => {
          console.log('Update complete, resetting state...');

          // ENHANCED: Reset state properly
          formState.isSubmitting = false;

          submitBtn.innerHTML = originalButtonText;
          submitBtn.disabled = false;

          disableForm(form, false);

          console.log('Update state reset complete');
      });
  }

  // NEW: Enhanced AI insights generation for new entries
  function generateAIInsightsForNewEntry(newEntryData) {
      console.log('Generating AI insights for new entry:', newEntryData);

      const insightsContainer = document.getElementById('aiInsights');
      if (!insightsContainer) return;

      // Show loading state with context about the new entry
      insightsContainer.className = 'ai-insights-fresh p-3 rounded';
      insightsContainer.innerHTML = `
          <div class="text-center">
              <div class="spinner-border spinner-border-sm text-primary mb-2" role="status">
                  <span class="visually-hidden">Loading...</span>
              </div>
              <h6 class="mb-1">Analyzing Your Latest Performance</h6>
              <p class="mb-0 small">AI is reviewing your new entry for ${newEntryData.date}...</p>
          </div>
      `;

      // Calculate some quick stats for context
      const roomVariance = parseFloat(newEntryData.actual_room_rate) - parseFloat(newEntryData.target_room_rate);
      const revenueVariance = parseFloat(newEntryData.actual_revenue) - parseFloat(newEntryData.target_revenue);
      const roomVariancePct = ((roomVariance / parseFloat(newEntryData.target_room_rate)) * 100).toFixed(1);
      const revenueVariancePct = ((revenueVariance / parseFloat(newEntryData.target_revenue)) * 100).toFixed(1);

      // Enhanced API call with context about the new entry
      fetch('/analyze?metric=revenue&new_entry=true', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
              latest_entry: {
                  date: newEntryData.date,
                  room_rate_variance_pct: roomVariancePct,
                  revenue_variance_pct: revenueVariancePct,
                  notes: newEntryData.notes || '',
                  target_room_rate: newEntryData.target_room_rate,
                  actual_room_rate: newEntryData.actual_room_rate,
                  target_revenue: newEntryData.target_revenue,
                  actual_revenue: newEntryData.actual_revenue
              }
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              insightsContainer.innerHTML = `
                  <div class="d-flex align-items-start">
                      <div class="me-2">
                          <i class="fas fa-sparkles text-primary"></i>
                      </div>
                      <div class="flex-grow-1">
                          <h6 class="mb-2 text-primary">
                              <i class="fas fa-robot me-1"></i>Fresh AI Analysis
                          </h6>
                          <p class="mb-2">${data.analysis}</p>
                          <div class="row text-center mt-3">
                              <div class="col-6">
                                  <small class="text-muted">Room Rate</small><br>
                                  <span class="badge bg-${roomVariance >= 0 ? 'success' : 'danger'}">${roomVariancePct}%</span>
                              </div>
                              <div class="col-6">
                                  <small class="text-muted">Revenue</small><br>
                                  <span class="badge bg-${revenueVariance >= 0 ? 'success' : 'danger'}">${revenueVariancePct}%</span>
                              </div>
                          </div>
                          <small class="text-muted mt-2 d-block">
                              <i class="fas fa-clock me-1"></i>Generated ${new Date().toLocaleTimeString()} • Based on ${data.data_points_analyzed} data points
                          </small>
                      </div>
                  </div>
              `;
          } else {
              insightsContainer.innerHTML = `
                  <div class="text-warning">
                      <i class="fas fa-exclamation-triangle me-1"></i>
                      ${data.error || 'Unable to generate insights for your new entry'}
                  </div>
              `;
          }
      })
      .catch(error => {
          console.error('Error generating insights for new entry:', error);
          insightsContainer.innerHTML = `
              <div class="text-danger">
                  <i class="fas fa-times me-1"></i>
                  Failed to generate insights. You can manually refresh for general insights.
              </div>
          `;
      });
  }

  // ENHANCED: Helper functions
  function validateFormData(form) {
      const requiredFields = form.querySelectorAll('[required]');
      let isValid = true;

      requiredFields.forEach(field => {
          if (!field.value.trim()) {
              field.classList.add('is-invalid');
              isValid = false;
          } else {
              field.classList.remove('is-invalid');
          }
      });

      if (!isValid) {
          showNotification('Please fill in all required fields.', 'warning');
      }

      return isValid;
  }

  function disableForm(form, disabled) {
      const inputs = form.querySelectorAll('input, select, textarea, button');
      inputs.forEach(input => {
          input.disabled = disabled;
      });
  }

  function resetForm(form) {
      form.reset();
      document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('variancePreview').style.display = 'none';

      // Clear validation states
      const invalidFields = form.querySelectorAll('.is-invalid');
      invalidFields.forEach(field => field.classList.remove('is-invalid'));
  }

  // ENHANCED: Better notification system
  function showNotification(message, type = 'info') {
      console.log(`Notification [${type}]: ${message}`);

      // Create notification element
      const notification = document.createElement('div');
      notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
      notification.style.top = '20px';
      notification.style.right = '20px';
      notification.style.zIndex = '9999';
      notification.style.minWidth = '300px';
      notification.style.maxWidth = '500px';

      const iconMap = {
          'success': 'check-circle',
          'error': 'exclamation-triangle',
          'warning': 'exclamation-circle',
          'info': 'info-circle'
      };

      notification.innerHTML = `
          <i class="fas fa-${iconMap[type] || 'info-circle'} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;

      document.body.appendChild(notification);

      // Auto-remove after delay (longer for errors)
      const delay = type === 'error' ? 8000 : type === 'warning' ? 6000 : 4000;
      setTimeout(() => {
          if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
          }
      }, delay);
  }

  // AI Insights functionality (manual refresh)
  document.addEventListener('DOMContentLoaded', function() {
      const insightsBtn = document.getElementById('generateInsightsBtn');
      if (insightsBtn) {
          insightsBtn.addEventListener('click', function() {
              generateAIInsights();
          });
      }
  });

  function generateAIInsights() {
      const insightsBtn = document.getElementById('generateInsightsBtn');
      const insightsContainer = document.getElementById('aiInsights');

      if (!insightsBtn || !insightsContainer) return;

      insightsBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
      insightsBtn.disabled = true;

      insightsContainer.innerHTML = `
          <div class="text-center py-3">
              <div class="spinner-border spinner-border-sm text-primary mb-2" role="status">
                  <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mb-0">AI is analyzing your performance data...</p>
          </div>
      `;

      fetch('/analyze?metric=revenue')
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  insightsContainer.innerHTML = `
                      <div class="small">
                          <strong>AI Insights:</strong>
                          <p class="mb-2 mt-2">${data.analysis}</p>
                          <small class="text-muted">
                              Based on ${data.data_points_analyzed} data points
                          </small>
                      </div>
                  `;
              } else {
                  insightsContainer.innerHTML = `
                      <div class="text-warning small">
                          <i class="fas fa-exclamation-triangle me-1"></i>
                          ${data.error || 'Unable to generate insights'}
                      </div>
                  `;
              }
          })
          .catch(error => {
              console.error('Error generating insights:', error);
              insightsContainer.innerHTML = `
                  <div class="text-danger small">
                      <i class="fas fa-times me-1"></i>
                      Failed to generate insights. Please try again.
                  </div>
              `;
          })
          .finally(() => {
              insightsBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh';
              insightsBtn.disabled = false;
          });
  }
</script>
{% endblock %}
